kind: Stage
id: nectar.operations.telem.stage-1
title: Auditing
info: Nectar telemetry persistence
steps:
  - kind: Step
    id: nectar.operations.telem.stage-1.step-1
    title: Telemetry Persistence
    info: "Nectar saves telemetry for important events so that users
     can later audit their application.<br/><br/>For this, a persistent database
     is required. This step helps you decide where and how to host it."
    tam:
      type: image
      uri: gcr.io/nectar-bazaar/telem-tami
      version: 1.0.0
    action:
      kind: StepApplyResAction
      apply_filters:
        - k8s_kind: xyz
          field_selector:
            metadata.something: something
            something.else: foar
          label_selector:
            something: something

    fields:
      - id: nectar.telem.strategy
        title: Database Strategy
        input:
          kind: SelectInput
          options:
            managed_pvc: "Managed PVC: in-cluster storage managed by Nectar"
            nectar_cloud: "Nectar cloud storage: secure remote database"
            self_managed: "Own storage: you supply a Redis database"
            disabled: "Disabled: telemetry will not be persisted"
        validation:
          - check_against: disabled
            operator: =/=
            tone: warning
            reason: "Auditing will not be available. You can turn this on later."
          - check_against: self_managed
            operator: =/=
            tone: warning
            reason: "You will be responsible for managing this database."
          - check_against: nectar_cloud
            operator: =/=
            tone: error
            reason: "Not available for your current plan"
      - id: nectar.telem.db_host
        title: Redis database host
        validation:
          - kind: FormatPredicate
            check_against: domain
        show_condition:
          challenge: "{nectar.telem.strategy}"
          check_against: self_managed
      - id: nectar.telem.db_port
        title: Telem Redis database host
        validation:
          - kind: FormatPredicate
            check_against: integer
        show_condition:
          challenge: "{nectar.telem.strategy}"
          check_against: self_managed
