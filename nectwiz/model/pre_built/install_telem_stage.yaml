kind: Stage
id: nectar.operations.telem.stage-1
title: Auditing
info: Nectar auditing preferences
steps:
  - kind: Step
    id: nectar.operations.telem.stage-1.step-1
    title: Telemetry Persistence
    info: "Nectar saves telemetry for important events so that users
     can later audit their application. For this, a persistent database
     is required. This step helps you decide where and how to host it."
    action:
      kind: ApplyManifestAction
      tam:
        type: image
        uri: gcr.io/nectar-bazaar/telem-tami
        version: 1.0.0
    fields:
      - id: telem_storage.strategy
        title: Database Strategy
        default: managed_pvc
        input:
          kind: SelectInput
          options:
            managed_pvc: "Managed PVC: in-cluster storage managed by Nectar"
            nectar_cloud: "Nectar cloud storage: secure remote database"
            self_managed: "Own storage: you supply a Redis database"
            disabled: "Disabled: telemetry will not be persisted"
        validation:
          - check_against: disabled
            operator: =/=
            tone: warning
            reason: "Auditing will not be available. You can turn this on later."
          - check_against: self_managed
            operator: =/=
            tone: warning
            reason: "You will be responsible for managing this database."
          - check_against: nectar_cloud
            operator: =/=
            tone: error
            reason: "Not available for your current plan"
      - id: telem_storage.host
        title: Redis database host
        validation:
          - kind: FormatPredicate
            check_against: domain
        show_condition:
          challenge: "{nectar.telem.strategy}"
          check_against: self_managed
      - id: telem_storage.port
        title: Telem Redis database host
        default: 6379
        validation:
          - kind: FormatPredicate
            check_against: integer
        show_condition:
          challenge: "{nectar.telem.strategy}"
          check_against: self_managed