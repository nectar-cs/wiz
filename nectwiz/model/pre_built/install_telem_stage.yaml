kind: Stage
id: nectar.stage.telem
title: Auditing
info: Nectar telemetry persistence
steps:
  - kind: Step
    id: nectar.step.telem.main
    title: Persistence
    info: "Nectar saves telemetry for important events
     to enable convenient auditing.<br/><br/>For this, a persistent database
     is required. Choose one of the following ways host it."
    tam:
      type: image
      uri: gcr.io/nectar-bazaar/telem-tami
      version: latest
    fields:
      - id: nectar.field.telem.strategy
        title: Database Strategy
          input:
            options:
              managed_pvc: "Managed PVC: in-cluster storage managed by Nectar"
              nectar_cloud: "Cloud storage: remote Nectar database"
              self_managed: "Own storage: you supply a Redis database"
          disabled: "Disabled: telemetry will not be persisted"
        validations:
          - operator: equals
            check_against: none
            disabled: warning
            message: "Auditing will not be available. You can turn this on later."
          - operator: equals
            check_against: self_managed
            disabled: warning
            message: "You will be responsible for managing this database."
          - operator: equals
            check_against: nectar_cloud
            disabled: error
            message: "Not available for your current plan"
      - id: nectar.field.telem.db_host
        title: Redis database host
        validations:
          - kind: FormatValidator
            check_against: domain
        show_condition:
          operator: equals
          challenge: $input/nectar.field.telem.strategy
          check_against: self_managed
      - id: nectar.field.telem.db_port
        title: Redis database host
        validations:
          - kind: FormatValidator
            check_against: integer
        show_condition:
          operator: equals
          challenge: $input/nectar.field.telem.strategy
          check_against: self_managed